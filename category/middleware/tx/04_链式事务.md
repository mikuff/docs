> 链式事务主要针对单应用-多数据源的情况下,非XA模式(Best Efforts 1PC)
## 配置
### yml
``` yml
spring:
  ds-one:
    driver-class-name: com.mysql.jdbc.Driver
    username: root
    password: 123
    url: jdbc:mysql://192.168.111.10:3306/test_tx
  ds-two:
    driver-class-name: com.mysql.jdbc.Driver
    username: root
    password: 123
    url: jdbc:mysql://192.168.111.11:3306/test_tx
```

### DbConfiguration
``` java

// MapperScan 注解是指定包下面的mapper使用那个数据源
@Configuration
@MapperScan(basePackages = {"com.lwl.chaintx.mapper.dsone"}, sqlSessionFactoryRef = "dsOneSqlSessionFactory")
@MapperScan(basePackages = {"com.lwl.chaintx.mapper.dstwo"}, sqlSessionFactoryRef = "dsTwoSqlSessionFactory")
public class DbConfiguration {

    // 数据源dsOne
    @Bean
    @Primary
    @ConfigurationProperties(prefix = "spring.ds-one")
    public DataSourceProperties dsOneProperties() {
        return new DataSourceProperties();
    }

    @Bean
    @Primary
    public DataSource dsOneDataSource() {
        return dsOneProperties()
                .initializeDataSourceBuilder()
                .type(HikariDataSource.class).build();
    }

    // 数据源dsTwo
    @Bean
    @ConfigurationProperties(prefix = "spring.ds-two")
    public DataSourceProperties dsTwoProperties() {
        return new DataSourceProperties();
    }

    @Bean
    public DataSource dsTwoDataSource() {
        return dsTwoProperties()
                .initializeDataSourceBuilder()
                .type(HikariDataSource.class).build();
    }


    // 用于使用的是mybatis，因此通过数据dsOne构建MybatisSqlSessionFactoryBean
    // 如果是jdbc则直接构建jdbcTemplate
    @Bean
    public SqlSessionFactory dsOneSqlSessionFactory() throws Exception {
        MybatisSqlSessionFactoryBean factoryBean = new MybatisSqlSessionFactoryBean();
        factoryBean.setDataSource(dsOneDataSource());
        factoryBean.setMapperLocations(new PathMatchingResourcePatternResolver().getResources("classpath*:mapper/*.xml"));
        return factoryBean.getObject();
    }

    @Bean
    public SqlSessionTemplate dsOneSqlSessionTemplate() throws Exception {
        SqlSessionTemplate template = new SqlSessionTemplate(dsOneSqlSessionFactory());
        return template;
    }

    // dsTwo构建MybatisSqlSessionFactoryBean
    @Bean
    public SqlSessionFactory dsTwoSqlSessionFactory() throws Exception {
        MybatisSqlSessionFactoryBean factoryBean = new MybatisSqlSessionFactoryBean();
        factoryBean.setDataSource(dsTwoDataSource());
        factoryBean.setMapperLocations(new PathMatchingResourcePatternResolver().getResources("classpath*:mapper/*.xml"));
        return factoryBean.getObject();
    }

    @Bean
    public SqlSessionTemplate dsTwoSqlSessionTemplate() throws Exception {
        SqlSessionTemplate template = new SqlSessionTemplate(dsTwoSqlSessionFactory());
        return template;
    }
}
```

## 无事务管理器
在不配置事务管理器的情况下，存在数据源dsOne,dsTwo。其中dsOne为@Primary。添加@Transactional事务由spring所管理
- 只存在数据源dsOne，@Transactional注解生效,执行失败则回滚
- 只存在数据源dsTwo，@Transactional注解失效,执行失败无法回滚
- 存在数据源dsOne,dsTwo，@Transactional注解失效,执行失败dsOne回滚,dsTwo无法回滚
根据以上情况可以看出，在没有配置事务管理器的情况下，@Primary注解的数据源事务生效，其他数据源事务无效

### 数据源dsOne,dsTwo回滚日志
@Primary对同一个接口，可能会有几种不同的实现类，而默认只会采取其中一种的情况下。从日志  Rolling back JDBC transaction on Connection 中可以看出回滚的数据库连接是dsOne，而这个连接是@Primary的连接。将@Primary放到dsTwo的时候,同样从日志中可以看出回滚的是dsTwo。
``` log
2022-12-02 00:48:41.456 DEBUG 14576 --- [nio-8004-exec-1] o.s.j.d.DataSourceTransactionManager     : Creating new transaction with name [com.lwl.chaintx.service.ChainTxInfoServiceImpl.insertDbTwoError]: PROPAGATION_REQUIRED,ISOLATION_DEFAULT
2022-12-02 00:48:41.457  INFO 14576 --- [nio-8004-exec-1] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Starting...
2022-12-02 00:48:48.436  INFO 14576 --- [nio-8004-exec-1] com.zaxxer.hikari.pool.PoolBase          : HikariPool-1 - Driver does not support get/set network timeout for connections. (com.mysql.jdbc.JDBC4Connection.getNetworkTimeout()I)
2022-12-02 00:48:48.440  INFO 14576 --- [nio-8004-exec-1] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Start completed.
2022-12-02 00:48:48.443 DEBUG 14576 --- [nio-8004-exec-1] o.s.j.d.DataSourceTransactionManager     : Acquired Connection [HikariProxyConnection@1155242370 wrapping com.mysql.jdbc.JDBC4Connection@544dfcd3] for JDBC transaction
2022-12-02 00:48:48.445 DEBUG 14576 --- [nio-8004-exec-1] o.s.j.d.DataSourceTransactionManager     : Switching JDBC Connection [HikariProxyConnection@1155242370 wrapping com.mysql.jdbc.JDBC4Connection@544dfcd3] to manual commit
2022-12-02 00:48:48.446 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Bound value [org.springframework.jdbc.datasource.ConnectionHolder@4c3162d8] for key [HikariDataSource (HikariPool-1)] to thread [http-nio-8004-exec-1]
2022-12-02 00:48:48.446 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Initializing transaction synchronization
2022-12-02 00:48:48.446 TRACE 14576 --- [nio-8004-exec-1] o.s.t.i.TransactionInterceptor           : Getting transaction for [com.lwl.chaintx.service.ChainTxInfoServiceImpl.insertDbTwoError]
dsOne ======================================================================================
Creating a new SqlSession
Registering transaction synchronization for SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@36a176e3]
2022-12-02 00:48:48.462 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Bound value [org.mybatis.spring.SqlSessionHolder@764b39a8] for key [org.apache.ibatis.session.defaults.DefaultSqlSessionFactory@a66ebbc] to thread [http-nio-8004-exec-1]
2022-12-02 00:48:48.482 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.springframework.jdbc.datasource.ConnectionHolder@4c3162d8] for key [HikariDataSource (HikariPool-1)] bound to thread [http-nio-8004-exec-1]
2022-12-02 00:48:48.482 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.springframework.jdbc.datasource.ConnectionHolder@4c3162d8] for key [HikariDataSource (HikariPool-1)] bound to thread [http-nio-8004-exec-1]
JDBC Connection [HikariProxyConnection@1155242370 wrapping com.mysql.jdbc.JDBC4Connection@544dfcd3] will be managed by Spring
2022-12-02 00:48:48.486 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.springframework.jdbc.datasource.ConnectionHolder@4c3162d8] for key [HikariDataSource (HikariPool-1)] bound to thread [http-nio-8004-exec-1]
2022-12-02 00:48:48.486 DEBUG 14576 --- [nio-8004-exec-1] c.l.c.m.d.DsOneChainTxInfoMapper.insert  : ==>  Preparing: INSERT INTO chain_tx_info ( name, age, create_date ) VALUES ( ?, ?, ? )
2022-12-02 00:48:48.502 DEBUG 14576 --- [nio-8004-exec-1] c.l.c.m.d.DsOneChainTxInfoMapper.insert  : ==> Parameters: 11 error_dsOne(String), 11(Integer), 2022-02-02 00:00:00.0(Timestamp)
2022-12-02 00:48:48.504 DEBUG 14576 --- [nio-8004-exec-1] c.l.c.m.d.DsOneChainTxInfoMapper.insert  : <==    Updates: 1
2022-12-02 00:48:48.509 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.mybatis.spring.SqlSessionHolder@764b39a8] for key [org.apache.ibatis.session.defaults.DefaultSqlSessionFactory@a66ebbc] bound to thread [http-nio-8004-exec-1]
2022-12-02 00:48:48.509 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.mybatis.spring.SqlSessionHolder@764b39a8] for key [org.apache.ibatis.session.defaults.DefaultSqlSessionFactory@a66ebbc] bound to thread [http-nio-8004-exec-1]
Releasing transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@36a176e3]
dsTwo ======================================================================================
Creating a new SqlSession
Registering transaction synchronization for SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@6ca1deee]
2022-12-02 00:48:48.510 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Bound value [org.mybatis.spring.SqlSessionHolder@3b389b6e] for key [org.apache.ibatis.session.defaults.DefaultSqlSessionFactory@7adb9f37] to thread [http-nio-8004-exec-1]
2022-12-02 00:48:48.510 DEBUG 14576 --- [nio-8004-exec-1] o.s.jdbc.datasource.DataSourceUtils      : Fetching JDBC Connection from DataSource
2022-12-02 00:48:48.510  INFO 14576 --- [nio-8004-exec-1] com.zaxxer.hikari.HikariDataSource       : HikariPool-2 - Starting...
2022-12-02 00:48:56.342  INFO 14576 --- [nio-8004-exec-1] com.zaxxer.hikari.pool.PoolBase          : HikariPool-2 - Driver does not support get/set network timeout for connections. (com.mysql.jdbc.JDBC4Connection.getNetworkTimeout()I)
2022-12-02 00:48:56.343  INFO 14576 --- [nio-8004-exec-1] com.zaxxer.hikari.HikariDataSource       : HikariPool-2 - Start completed.
2022-12-02 00:48:56.344 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Bound value [org.springframework.jdbc.datasource.ConnectionHolder@3ab3225e] for key [HikariDataSource (HikariPool-2)] to thread [http-nio-8004-exec-1]
2022-12-02 00:48:56.344 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.springframework.jdbc.datasource.ConnectionHolder@3ab3225e] for key [HikariDataSource (HikariPool-2)] bound to thread [http-nio-8004-exec-1]
JDBC Connection [HikariProxyConnection@1380915368 wrapping com.mysql.jdbc.JDBC4Connection@244f159e] will be managed by Spring
2022-12-02 00:48:56.345 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.springframework.jdbc.datasource.ConnectionHolder@3ab3225e] for key [HikariDataSource (HikariPool-2)] bound to thread [http-nio-8004-exec-1]
2022-12-02 00:48:56.345 DEBUG 14576 --- [nio-8004-exec-1] c.l.c.m.d.DsTwoChainTxInfoMapper.insert  : ==>  Preparing: INSERT INTO chain_tx_info ( name, age, create_date ) VALUES ( ?, ?, ? )
2022-12-02 00:48:56.345 DEBUG 14576 --- [nio-8004-exec-1] c.l.c.m.d.DsTwoChainTxInfoMapper.insert  : ==> Parameters: 11 error_dsTwo(String), 11(Integer), 2022-02-02 00:00:00.0(Timestamp)
2022-12-02 00:48:56.350 DEBUG 14576 --- [nio-8004-exec-1] c.l.c.m.d.DsTwoChainTxInfoMapper.insert  : <==    Updates: 1
2022-12-02 00:48:56.351 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.mybatis.spring.SqlSessionHolder@3b389b6e] for key [org.apache.ibatis.session.defaults.DefaultSqlSessionFactory@7adb9f37] bound to thread [http-nio-8004-exec-1]
2022-12-02 00:48:56.351 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.mybatis.spring.SqlSessionHolder@3b389b6e] for key [org.apache.ibatis.session.defaults.DefaultSqlSessionFactory@7adb9f37] bound to thread [http-nio-8004-exec-1]
Releasing transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@6ca1deee]
throw exception ======================================================================================
2022-12-02 00:48:56.351 TRACE 14576 --- [nio-8004-exec-1] o.s.t.i.TransactionInterceptor           : Completing transaction for [com.lwl.chaintx.service.ChainTxInfoServiceImpl.insertDbTwoError] after exception: java.lang.RuntimeException
2022-12-02 00:48:56.351 TRACE 14576 --- [nio-8004-exec-1] o.s.t.i.RuleBasedTransactionAttribute    : Applying rules to determine whether transaction should rollback on java.lang.RuntimeException
2022-12-02 00:48:56.351 TRACE 14576 --- [nio-8004-exec-1] o.s.t.i.RuleBasedTransactionAttribute    : Winning rollback rule is: null
2022-12-02 00:48:56.351 TRACE 14576 --- [nio-8004-exec-1] o.s.t.i.RuleBasedTransactionAttribute    : No relevant rollback rule found: applying default rules
2022-12-02 00:48:56.351 TRACE 14576 --- [nio-8004-exec-1] o.s.j.d.DataSourceTransactionManager     : Triggering beforeCompletion synchronization
Transaction synchronization deregistering SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@36a176e3]
2022-12-02 00:48:56.351 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Removed value [org.mybatis.spring.SqlSessionHolder@764b39a8] for key [org.apache.ibatis.session.defaults.DefaultSqlSessionFactory@a66ebbc] from thread [http-nio-8004-exec-1]
Transaction synchronization closing SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@36a176e3]
2022-12-02 00:48:56.352 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.springframework.jdbc.datasource.ConnectionHolder@4c3162d8] for key [HikariDataSource (HikariPool-1)] bound to thread [http-nio-8004-exec-1]
Transaction synchronization deregistering SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@6ca1deee]
2022-12-02 00:48:56.352 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Removed value [org.mybatis.spring.SqlSessionHolder@3b389b6e] for key [org.apache.ibatis.session.defaults.DefaultSqlSessionFactory@7adb9f37] from thread [http-nio-8004-exec-1]
Transaction synchronization closing SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@6ca1deee]
2022-12-02 00:48:56.352 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.springframework.jdbc.datasource.ConnectionHolder@3ab3225e] for key [HikariDataSource (HikariPool-2)] bound to thread [http-nio-8004-exec-1]
2022-12-02 00:48:56.352 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Removed value [org.springframework.jdbc.datasource.ConnectionHolder@3ab3225e] for key [HikariDataSource (HikariPool-2)] from thread [http-nio-8004-exec-1]
2022-12-02 00:48:56.353 DEBUG 14576 --- [nio-8004-exec-1] o.s.j.d.DataSourceTransactionManager     : Initiating transaction rollback
2022-12-02 00:48:56.353 DEBUG 14576 --- [nio-8004-exec-1] o.s.j.d.DataSourceTransactionManager     : Rolling back JDBC transaction on Connection [HikariProxyConnection@1155242370 wrapping com.mysql.jdbc.JDBC4Connection@544dfcd3]
2022-12-02 00:48:56.357 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Clearing transaction synchronization
2022-12-02 00:48:56.357 TRACE 14576 --- [nio-8004-exec-1] o.s.j.d.DataSourceTransactionManager     : Triggering afterCompletion synchronization
2022-12-02 00:48:56.357 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Removed value [org.springframework.jdbc.datasource.ConnectionHolder@4c3162d8] for key [HikariDataSource (HikariPool-1)] from thread [http-nio-8004-exec-1]
2022-12-02 00:48:56.358 DEBUG 14576 --- [nio-8004-exec-1] o.s.j.d.DataSourceTransactionManager     : Releasing JDBC Connection [HikariProxyConnection@1155242370 wrapping com.mysql.jdbc.JDBC4Connection@544dfcd3] after transaction
2022-12-02 00:48:56.358 ERROR 14576 --- [nio-8004-exec-1] c.l.chaintx.controller.ChainController   : insertDbTwoError executor error: null
```

## 事务管理器
### 单数据源事务管理器
在每个数据源单独配置事务管理器的情况下，@Transactional 需要指定对应数据源使用的事务管理器. @Transactional(rollbackFor = Exception.class,transactionManager = "dsOneTransactionManager")
- 只存在数据源dsOne，@Transactional注解生效,执行正常
- 只存在数据源dsTwo，@Transactional注解失效,执行正常
- 存在数据源dsOne,dsTwo，@Transactional注解失效，指定的transactionManager生效，其他无效


``` java
@Configuration
@MapperScan(basePackages = {"com.lwl.chaintx.mapper.dsone"}, sqlSessionFactoryRef = "dsOneSqlSessionFactory")
@MapperScan(basePackages = {"com.lwl.chaintx.mapper.dstwo"}, sqlSessionFactoryRef = "dsTwoSqlSessionFactory")
public class DbConfiguration {
    // 数据源dsOne的事务管理器
    @Bean(name = "dsOneTransactionManager")
    public DataSourceTransactionManager dsOneTransactionManager() {
        return new DataSourceTransactionManager(dsOneDataSource());
    }

    // 数据源dsTwo的事务管理器
    @Bean(name = "dsTwoTransactionManager")
    public DataSourceTransactionManager dsTwoTransactionManager() {
        return new DataSourceTransactionManager(dsTwoDataSource());
    }
}
```

### 链式事务管理器
ChainedTransactionManager只是同时开启两个事务，自动的对两个事务，顺序开启，顺序提交或回滚。它对多个数据源写数据，并不是一个原子操作，不能像XA那样保证对数据操作的完整性，一致性。通过底层源码可以看出是使用  List<PlatformTransactionManager>来维护事务列表。
在异常的情况下,会以声明阶段相反的顺序发生回滚。**如果第一个事务已经提交，第二个事务没有提交，则整个事务没有办法回滚**。并且ChainedTransactionManager已经在sring新版本中标记为废弃。建议使用JTA强性事务。

``` java
@Configuration
@MapperScan(basePackages = {"com.lwl.chaintx.mapper.dsone"}, sqlSessionFactoryRef = "dsOneSqlSessionFactory")
@MapperScan(basePackages = {"com.lwl.chaintx.mapper.dstwo"}, sqlSessionFactoryRef = "dsTwoSqlSessionFactory")
public class DbConfiguration {

    @Bean
    public PlatformTransactionManager chainedTransactionManager() {
        return new ChainedTransactionManager(dsOneTransactionManager(), dsTwoTransactionManager());
    }
}
```


``` log
2022-12-04 14:49:53.908 TRACE 20088 --- [nio-8004-exec-4] .s.t.s.TransactionSynchronizationManager : Initializing transaction synchronization
2022-12-04 14:49:53.908 TRACE 20088 --- [nio-8004-exec-4] .s.t.s.TransactionSynchronizationManager : Clearing transaction synchronization
2022-12-04 14:49:53.908 DEBUG 20088 --- [nio-8004-exec-4] o.s.j.d.DataSourceTransactionManager     : Creating new transaction with name [com.lwl.chaintx.service.ChainTxInfoServiceImpl.insertAllDbError]: PROPAGATION_REQUIRED,ISOLATION_DEFAULT; 'chainedTransactionManager',-java.lang.Exception
2022-12-04 14:49:53.909 DEBUG 20088 --- [nio-8004-exec-4] o.s.j.d.DataSourceTransactionManager     : Acquired Connection [HikariProxyConnection@1892315266 wrapping com.mysql.jdbc.JDBC4Connection@3cbc801a] for JDBC transaction
2022-12-04 14:49:53.909 DEBUG 20088 --- [nio-8004-exec-4] o.s.j.d.DataSourceTransactionManager     : Switching JDBC Connection [HikariProxyConnection@1892315266 wrapping com.mysql.jdbc.JDBC4Connection@3cbc801a] to manual commit
2022-12-04 14:49:53.910 TRACE 20088 --- [nio-8004-exec-4] .s.t.s.TransactionSynchronizationManager : Bound value [org.springframework.jdbc.datasource.ConnectionHolder@7e0d90eb] for key [HikariDataSource (HikariPool-1)] to thread [http-nio-8004-exec-4]
2022-12-04 14:49:53.910 TRACE 20088 --- [nio-8004-exec-4] .s.t.s.TransactionSynchronizationManager : Initializing transaction synchronization
2022-12-04 14:49:53.910 TRACE 20088 --- [nio-8004-exec-4] .s.t.s.TransactionSynchronizationManager : Clearing transaction synchronization
2022-12-04 14:49:53.910 DEBUG 20088 --- [nio-8004-exec-4] o.s.j.d.DataSourceTransactionManager     : Creating new transaction with name [com.lwl.chaintx.service.ChainTxInfoServiceImpl.insertAllDbError]: PROPAGATION_REQUIRED,ISOLATION_DEFAULT; 'chainedTransactionManager',-java.lang.Exception
2022-12-04 14:49:53.911 DEBUG 20088 --- [nio-8004-exec-4] o.s.j.d.DataSourceTransactionManager     : Acquired Connection [HikariProxyConnection@2050104306 wrapping com.mysql.jdbc.JDBC4Connection@2c2a0b20] for JDBC transaction
2022-12-04 14:49:53.911 DEBUG 20088 --- [nio-8004-exec-4] o.s.j.d.DataSourceTransactionManager     : Switching JDBC Connection [HikariProxyConnection@2050104306 wrapping com.mysql.jdbc.JDBC4Connection@2c2a0b20] to manual commit
2022-12-04 14:49:53.911 TRACE 20088 --- [nio-8004-exec-4] .s.t.s.TransactionSynchronizationManager : Bound value [org.springframework.jdbc.datasource.ConnectionHolder@3f309ad0] for key [HikariDataSource (HikariPool-2)] to thread [http-nio-8004-exec-4]
2022-12-04 14:49:53.912 TRACE 20088 --- [nio-8004-exec-4] .s.t.s.TransactionSynchronizationManager : Initializing transaction synchronization
2022-12-04 14:49:53.912 TRACE 20088 --- [nio-8004-exec-4] o.s.t.i.TransactionInterceptor           : Getting transaction for [com.lwl.chaintx.service.ChainTxInfoServiceImpl.insertAllDbError]
dsOne ======================================================================================
Creating a new SqlSession
Registering transaction synchronization for SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@1cddb3d4]
2022-12-04 14:49:53.912 TRACE 20088 --- [nio-8004-exec-4] .s.t.s.TransactionSynchronizationManager : Bound value [org.mybatis.spring.SqlSessionHolder@e45e26c] for key [org.apache.ibatis.session.defaults.DefaultSqlSessionFactory@4d583982] to thread [http-nio-8004-exec-4]
2022-12-04 14:49:53.912 TRACE 20088 --- [nio-8004-exec-4] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.springframework.jdbc.datasource.ConnectionHolder@7e0d90eb] for key [HikariDataSource (HikariPool-1)] bound to thread [http-nio-8004-exec-4]
2022-12-04 14:49:53.912 TRACE 20088 --- [nio-8004-exec-4] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.springframework.jdbc.datasource.ConnectionHolder@7e0d90eb] for key [HikariDataSource (HikariPool-1)] bound to thread [http-nio-8004-exec-4]
JDBC Connection [HikariProxyConnection@1892315266 wrapping com.mysql.jdbc.JDBC4Connection@3cbc801a] will be managed by Spring
2022-12-04 14:49:53.912 TRACE 20088 --- [nio-8004-exec-4] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.springframework.jdbc.datasource.ConnectionHolder@7e0d90eb] for key [HikariDataSource (HikariPool-1)] bound to thread [http-nio-8004-exec-4]
2022-12-04 14:49:53.912 DEBUG 20088 --- [nio-8004-exec-4] c.l.c.m.d.DsOneChainTxInfoMapper.insert  : ==>  Preparing: INSERT INTO chain_tx_info ( name, age, create_date ) VALUES ( ?, ?, ? )
2022-12-04 14:49:53.913 DEBUG 20088 --- [nio-8004-exec-4] c.l.c.m.d.DsOneChainTxInfoMapper.insert  : ==> Parameters: all_dsOne(String), 111(Integer), 2022-10-11 00:00:00.0(Timestamp)
2022-12-04 14:49:53.914 DEBUG 20088 --- [nio-8004-exec-4] c.l.c.m.d.DsOneChainTxInfoMapper.insert  : <==    Updates: 1
2022-12-04 14:49:53.914 TRACE 20088 --- [nio-8004-exec-4] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.mybatis.spring.SqlSessionHolder@e45e26c] for key [org.apache.ibatis.session.defaults.DefaultSqlSessionFactory@4d583982] bound to thread [http-nio-8004-exec-4]
2022-12-04 14:49:53.914 TRACE 20088 --- [nio-8004-exec-4] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.mybatis.spring.SqlSessionHolder@e45e26c] for key [org.apache.ibatis.session.defaults.DefaultSqlSessionFactory@4d583982] bound to thread [http-nio-8004-exec-4]
Releasing transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@1cddb3d4]
dsTwo ======================================================================================
Creating a new SqlSession
Registering transaction synchronization for SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@2e2d2ebb]
2022-12-04 14:49:53.914 TRACE 20088 --- [nio-8004-exec-4] .s.t.s.TransactionSynchronizationManager : Bound value [org.mybatis.spring.SqlSessionHolder@fdaef90] for key [org.apache.ibatis.session.defaults.DefaultSqlSessionFactory@49597764] to thread [http-nio-8004-exec-4]
2022-12-04 14:49:53.915 TRACE 20088 --- [nio-8004-exec-4] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.springframework.jdbc.datasource.ConnectionHolder@3f309ad0] for key [HikariDataSource (HikariPool-2)] bound to thread [http-nio-8004-exec-4]
2022-12-04 14:49:53.915 TRACE 20088 --- [nio-8004-exec-4] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.springframework.jdbc.datasource.ConnectionHolder@3f309ad0] for key [HikariDataSource (HikariPool-2)] bound to thread [http-nio-8004-exec-4]
JDBC Connection [HikariProxyConnection@2050104306 wrapping com.mysql.jdbc.JDBC4Connection@2c2a0b20] will be managed by Spring
2022-12-04 14:49:53.915 TRACE 20088 --- [nio-8004-exec-4] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.springframework.jdbc.datasource.ConnectionHolder@3f309ad0] for key [HikariDataSource (HikariPool-2)] bound to thread [http-nio-8004-exec-4]
2022-12-04 14:49:53.915 DEBUG 20088 --- [nio-8004-exec-4] c.l.c.m.d.DsTwoChainTxInfoMapper.insert  : ==>  Preparing: INSERT INTO chain_tx_info ( name, age, create_date ) VALUES ( ?, ?, ? )
2022-12-04 14:49:53.915 DEBUG 20088 --- [nio-8004-exec-4] c.l.c.m.d.DsTwoChainTxInfoMapper.insert  : ==> Parameters: all_dsTwo(String), 111(Integer), 2022-10-11 00:00:00.0(Timestamp)
2022-12-04 14:49:53.916 DEBUG 20088 --- [nio-8004-exec-4] c.l.c.m.d.DsTwoChainTxInfoMapper.insert  : <==    Updates: 1
2022-12-04 14:49:53.917 TRACE 20088 --- [nio-8004-exec-4] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.mybatis.spring.SqlSessionHolder@fdaef90] for key [org.apache.ibatis.session.defaults.DefaultSqlSessionFactory@49597764] bound to thread [http-nio-8004-exec-4]
2022-12-04 14:49:53.917 TRACE 20088 --- [nio-8004-exec-4] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.mybatis.spring.SqlSessionHolder@fdaef90] for key [org.apache.ibatis.session.defaults.DefaultSqlSessionFactory@49597764] bound to thread [http-nio-8004-exec-4]
Releasing transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@2e2d2ebb]
throw exception ======================================================================================
2022-12-04 14:49:53.917 TRACE 20088 --- [nio-8004-exec-4] o.s.t.i.TransactionInterceptor           : Completing transaction for [com.lwl.chaintx.service.ChainTxInfoServiceImpl.insertAllDbError] after exception: java.lang.RuntimeException
2022-12-04 14:49:53.917 TRACE 20088 --- [nio-8004-exec-4] o.s.t.i.RuleBasedTransactionAttribute    : Applying rules to determine whether transaction should rollback on java.lang.RuntimeException
2022-12-04 14:49:53.917 TRACE 20088 --- [nio-8004-exec-4] o.s.t.i.RuleBasedTransactionAttribute    : Winning rollback rule is: RollbackRuleAttribute with pattern [java.lang.Exception]
2022-12-04 14:49:53.917 TRACE 20088 --- [nio-8004-exec-4] o.s.j.d.DataSourceTransactionManager     : Triggering beforeCompletion synchronization
Transaction synchronization deregistering SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@1cddb3d4]
2022-12-04 14:49:53.917 TRACE 20088 --- [nio-8004-exec-4] .s.t.s.TransactionSynchronizationManager : Removed value [org.mybatis.spring.SqlSessionHolder@e45e26c] for key [org.apache.ibatis.session.defaults.DefaultSqlSessionFactory@4d583982] from thread [http-nio-8004-exec-4]
Transaction synchronization closing SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@1cddb3d4]
2022-12-04 14:49:53.917 TRACE 20088 --- [nio-8004-exec-4] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.springframework.jdbc.datasource.ConnectionHolder@7e0d90eb] for key [HikariDataSource (HikariPool-1)] bound to thread [http-nio-8004-exec-4]
Transaction synchronization deregistering SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@2e2d2ebb]
2022-12-04 14:49:53.917 TRACE 20088 --- [nio-8004-exec-4] .s.t.s.TransactionSynchronizationManager : Removed value [org.mybatis.spring.SqlSessionHolder@fdaef90] for key [org.apache.ibatis.session.defaults.DefaultSqlSessionFactory@49597764] from thread [http-nio-8004-exec-4]
Transaction synchronization closing SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@2e2d2ebb]
2022-12-04 14:49:53.917 TRACE 20088 --- [nio-8004-exec-4] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.springframework.jdbc.datasource.ConnectionHolder@3f309ad0] for key [HikariDataSource (HikariPool-2)] bound to thread [http-nio-8004-exec-4]
2022-12-04 14:49:53.917 DEBUG 20088 --- [nio-8004-exec-4] o.s.j.d.DataSourceTransactionManager     : Initiating transaction rollback
// 回滚事务
2022-12-04 14:49:53.917 DEBUG 20088 --- [nio-8004-exec-4] o.s.j.d.DataSourceTransactionManager     : Rolling back JDBC transaction on Connection [HikariProxyConnection@2050104306 wrapping com.mysql.jdbc.JDBC4Connection@2c2a0b20]
2022-12-04 14:49:53.923 TRACE 20088 --- [nio-8004-exec-4] .s.t.s.TransactionSynchronizationManager : Clearing transaction synchronization
2022-12-04 14:49:53.923 TRACE 20088 --- [nio-8004-exec-4] o.s.j.d.DataSourceTransactionManager     : Triggering afterCompletion synchronization
2022-12-04 14:49:53.923 TRACE 20088 --- [nio-8004-exec-4] .s.t.s.TransactionSynchronizationManager : Removed value [org.springframework.jdbc.datasource.ConnectionHolder@3f309ad0] for key [HikariDataSource (HikariPool-2)] from thread [http-nio-8004-exec-4]
2022-12-04 14:49:53.924 DEBUG 20088 --- [nio-8004-exec-4] o.s.j.d.DataSourceTransactionManager     : Releasing JDBC Connection [HikariProxyConnection@2050104306 wrapping com.mysql.jdbc.JDBC4Connection@2c2a0b20] after transaction
2022-12-04 14:49:53.924 DEBUG 20088 --- [nio-8004-exec-4] o.s.j.d.DataSourceTransactionManager     : Resuming suspended transaction after completion of inner transaction
2022-12-04 14:49:53.924 TRACE 20088 --- [nio-8004-exec-4] .s.t.s.TransactionSynchronizationManager : Initializing transaction synchronization
2022-12-04 14:49:53.924 TRACE 20088 --- [nio-8004-exec-4] o.s.j.d.DataSourceTransactionManager     : Triggering beforeCompletion synchronization
2022-12-04 14:49:53.924 DEBUG 20088 --- [nio-8004-exec-4] o.s.j.d.DataSourceTransactionManager     : Initiating transaction rollback
// 回滚事务
2022-12-04 14:49:53.924 DEBUG 20088 --- [nio-8004-exec-4] o.s.j.d.DataSourceTransactionManager     : Rolling back JDBC transaction on Connection [HikariProxyConnection@1892315266 wrapping com.mysql.jdbc.JDBC4Connection@3cbc801a]
2022-12-04 14:49:53.930 TRACE 20088 --- [nio-8004-exec-4] .s.t.s.TransactionSynchronizationManager : Clearing transaction synchronization
2022-12-04 14:49:53.930 TRACE 20088 --- [nio-8004-exec-4] o.s.j.d.DataSourceTransactionManager     : Triggering afterCompletion synchronization
2022-12-04 14:49:53.930 TRACE 20088 --- [nio-8004-exec-4] .s.t.s.TransactionSynchronizationManager : Removed value [org.springframework.jdbc.datasource.ConnectionHolder@7e0d90eb] for key [HikariDataSource (HikariPool-1)] from thread [http-nio-8004-exec-4]
2022-12-04 14:49:53.931 DEBUG 20088 --- [nio-8004-exec-4] o.s.j.d.DataSourceTransactionManager     : Releasing JDBC Connection [HikariProxyConnection@1892315266 wrapping com.mysql.jdbc.JDBC4Connection@3cbc801a] after transaction
2022-12-04 14:49:53.931 DEBUG 20088 --- [nio-8004-exec-4] o.s.j.d.DataSourceTransactionManager     : Resuming suspended transaction after completion of inner transaction
2022-12-04 14:49:53.931 TRACE 20088 --- [nio-8004-exec-4] .s.t.s.TransactionSynchronizationManager : Initializing transaction synchronization
2022-12-04 14:49:53.931 ERROR 20088 --- [nio-8004-exec-4] c.l.chaintx.controller.ChainController   : insertAllDbError executor error: null

```

### 链式事务管理器的执行顺序
``` java
public class ChainedTransactionManager implements PlatformTransactionManager {
    // 维护的顺序消息列表
    private final List<PlatformTransactionManager> transactionManagers;

    public MultiTransactionStatus getTransaction(@Nullable TransactionDefinition definition) throws TransactionException {
        MultiTransactionStatus mts = new MultiTransactionStatus((PlatformTransactionManager)this.transactionManagers.get(0));
        if (definition == null) {
            return mts;
        } else {
            try {
                Iterator var3 = this.transactionManagers.iterator();
                // 顺序开启事务
                while(var3.hasNext()) {
                    PlatformTransactionManager transactionManager = (PlatformTransactionManager)var3.next();
                    mts.registerTransactionManager(definition, transactionManager);
                }

                return mts;
            } catch (Exception var9) {
            }
        }
    }

    public void commit(TransactionStatus status) throws TransactionException {
        // 倒序 commit
        Iterator var6 = this.reverse(this.transactionManagers).iterator();
        while(var6.hasNext()) {
        }
    }

    public void rollback(TransactionStatus status) throws TransactionException {
        // 倒序rollback 
        Iterator var5 = this.reverse(this.transactionManagers).iterator();
        while(var5.hasNext()) {
        }
    }
}


```
