> 链式事务主要针对单应用-多数据源的情况下。
## 配置
### yml
``` yml
spring:
  ds-one:
    driver-class-name: com.mysql.jdbc.Driver
    username: root
    password: 123
    url: jdbc:mysql://192.168.111.10:3306/test_tx
  ds-two:
    driver-class-name: com.mysql.jdbc.Driver
    username: root
    password: 123
    url: jdbc:mysql://192.168.111.11:3306/test_tx
```

### DbConfiguration
``` java

// MapperScan 注解是指定包下面的mapper使用那个数据源
@Configuration
@MapperScan(basePackages = {"com.lwl.chaintx.mapper.dsone"}, sqlSessionFactoryRef = "dsOneSqlSessionFactory")
@MapperScan(basePackages = {"com.lwl.chaintx.mapper.dstwo"}, sqlSessionFactoryRef = "dsTwoSqlSessionFactory")
public class DbConfiguration {

    // 数据源dsOne
    @Bean
    @Primary
    @ConfigurationProperties(prefix = "spring.ds-one")
    public DataSourceProperties dsOneProperties() {
        return new DataSourceProperties();
    }

    @Bean
    @Primary
    public DataSource dsOneDataSource() {
        return dsOneProperties()
                .initializeDataSourceBuilder()
                .type(HikariDataSource.class).build();
    }

    // 数据源dsTwo
    @Bean
    @ConfigurationProperties(prefix = "spring.ds-two")
    public DataSourceProperties dsTwoProperties() {
        return new DataSourceProperties();
    }

    @Bean
    public DataSource dsTwoDataSource() {
        return dsTwoProperties()
                .initializeDataSourceBuilder()
                .type(HikariDataSource.class).build();
    }


    // 用于使用的是mybatis，因此通过数据dsOne构建MybatisSqlSessionFactoryBean
    // 如果是jdbc则直接构建jdbcTemplate
    @Bean
    public SqlSessionFactory dsOneSqlSessionFactory() throws Exception {
        MybatisSqlSessionFactoryBean factoryBean = new MybatisSqlSessionFactoryBean();
        factoryBean.setDataSource(dsOneDataSource());
        factoryBean.setMapperLocations(new PathMatchingResourcePatternResolver().getResources("classpath*:mapper/*.xml"));
        return factoryBean.getObject();
    }

    @Bean
    public SqlSessionTemplate dsOneSqlSessionTemplate() throws Exception {
        SqlSessionTemplate template = new SqlSessionTemplate(dsOneSqlSessionFactory());
        return template;
    }

    // dsTwo构建MybatisSqlSessionFactoryBean
    @Bean
    public SqlSessionFactory dsTwoSqlSessionFactory() throws Exception {
        MybatisSqlSessionFactoryBean factoryBean = new MybatisSqlSessionFactoryBean();
        factoryBean.setDataSource(dsTwoDataSource());
        factoryBean.setMapperLocations(new PathMatchingResourcePatternResolver().getResources("classpath*:mapper/*.xml"));
        return factoryBean.getObject();
    }

    @Bean
    public SqlSessionTemplate dsTwoSqlSessionTemplate() throws Exception {
        SqlSessionTemplate template = new SqlSessionTemplate(dsTwoSqlSessionFactory());
        return template;
    }
}
```

## 无事务管理器
在不配置事务管理器的情况下，存在数据源dsOne,dsTwo。其中dsOne为@Primary。添加@Transactional事务由spring所管理
- 只存在数据源dsOne，@Transactional注解生效,执行失败则回滚
- 只存在数据源dsTwo，@Transactional注解失效,执行失败无法回滚
- 存在数据源dsOne,dsTwo，@Transactional注解失效,执行失败dsOne回滚,dsTwo无法回滚
根据以上情况可以看出，在没有配置事务管理器的情况下，@Primary注解的数据源事务生效，其他数据源事务无效

### 数据源dsOne,dsTwo回滚日志
@Primary对同一个接口，可能会有几种不同的实现类，而默认只会采取其中一种的情况下。从日志  Rolling back JDBC transaction on Connection 中可以看出回滚的数据库连接是dsOne，而这个连接是@Primary的连接。将@Primary放到dsTwo的时候,同样从日志中可以看出回滚的是dsTwo。
``` log
2022-12-02 00:48:41.456 DEBUG 14576 --- [nio-8004-exec-1] o.s.j.d.DataSourceTransactionManager     : Creating new transaction with name [com.lwl.chaintx.service.ChainTxInfoServiceImpl.insertDbTwoError]: PROPAGATION_REQUIRED,ISOLATION_DEFAULT
2022-12-02 00:48:41.457  INFO 14576 --- [nio-8004-exec-1] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Starting...
2022-12-02 00:48:48.436  INFO 14576 --- [nio-8004-exec-1] com.zaxxer.hikari.pool.PoolBase          : HikariPool-1 - Driver does not support get/set network timeout for connections. (com.mysql.jdbc.JDBC4Connection.getNetworkTimeout()I)
2022-12-02 00:48:48.440  INFO 14576 --- [nio-8004-exec-1] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Start completed.
2022-12-02 00:48:48.443 DEBUG 14576 --- [nio-8004-exec-1] o.s.j.d.DataSourceTransactionManager     : Acquired Connection [HikariProxyConnection@1155242370 wrapping com.mysql.jdbc.JDBC4Connection@544dfcd3] for JDBC transaction
2022-12-02 00:48:48.445 DEBUG 14576 --- [nio-8004-exec-1] o.s.j.d.DataSourceTransactionManager     : Switching JDBC Connection [HikariProxyConnection@1155242370 wrapping com.mysql.jdbc.JDBC4Connection@544dfcd3] to manual commit
2022-12-02 00:48:48.446 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Bound value [org.springframework.jdbc.datasource.ConnectionHolder@4c3162d8] for key [HikariDataSource (HikariPool-1)] to thread [http-nio-8004-exec-1]
2022-12-02 00:48:48.446 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Initializing transaction synchronization
2022-12-02 00:48:48.446 TRACE 14576 --- [nio-8004-exec-1] o.s.t.i.TransactionInterceptor           : Getting transaction for [com.lwl.chaintx.service.ChainTxInfoServiceImpl.insertDbTwoError]
dsOne ======================================================================================
Creating a new SqlSession
Registering transaction synchronization for SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@36a176e3]
2022-12-02 00:48:48.462 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Bound value [org.mybatis.spring.SqlSessionHolder@764b39a8] for key [org.apache.ibatis.session.defaults.DefaultSqlSessionFactory@a66ebbc] to thread [http-nio-8004-exec-1]
2022-12-02 00:48:48.482 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.springframework.jdbc.datasource.ConnectionHolder@4c3162d8] for key [HikariDataSource (HikariPool-1)] bound to thread [http-nio-8004-exec-1]
2022-12-02 00:48:48.482 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.springframework.jdbc.datasource.ConnectionHolder@4c3162d8] for key [HikariDataSource (HikariPool-1)] bound to thread [http-nio-8004-exec-1]
JDBC Connection [HikariProxyConnection@1155242370 wrapping com.mysql.jdbc.JDBC4Connection@544dfcd3] will be managed by Spring
2022-12-02 00:48:48.486 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.springframework.jdbc.datasource.ConnectionHolder@4c3162d8] for key [HikariDataSource (HikariPool-1)] bound to thread [http-nio-8004-exec-1]
2022-12-02 00:48:48.486 DEBUG 14576 --- [nio-8004-exec-1] c.l.c.m.d.DsOneChainTxInfoMapper.insert  : ==>  Preparing: INSERT INTO chain_tx_info ( name, age, create_date ) VALUES ( ?, ?, ? )
2022-12-02 00:48:48.502 DEBUG 14576 --- [nio-8004-exec-1] c.l.c.m.d.DsOneChainTxInfoMapper.insert  : ==> Parameters: 11 error_dsOne(String), 11(Integer), 2022-02-02 00:00:00.0(Timestamp)
2022-12-02 00:48:48.504 DEBUG 14576 --- [nio-8004-exec-1] c.l.c.m.d.DsOneChainTxInfoMapper.insert  : <==    Updates: 1
2022-12-02 00:48:48.509 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.mybatis.spring.SqlSessionHolder@764b39a8] for key [org.apache.ibatis.session.defaults.DefaultSqlSessionFactory@a66ebbc] bound to thread [http-nio-8004-exec-1]
2022-12-02 00:48:48.509 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.mybatis.spring.SqlSessionHolder@764b39a8] for key [org.apache.ibatis.session.defaults.DefaultSqlSessionFactory@a66ebbc] bound to thread [http-nio-8004-exec-1]
Releasing transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@36a176e3]
dsTwo ======================================================================================
Creating a new SqlSession
Registering transaction synchronization for SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@6ca1deee]
2022-12-02 00:48:48.510 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Bound value [org.mybatis.spring.SqlSessionHolder@3b389b6e] for key [org.apache.ibatis.session.defaults.DefaultSqlSessionFactory@7adb9f37] to thread [http-nio-8004-exec-1]
2022-12-02 00:48:48.510 DEBUG 14576 --- [nio-8004-exec-1] o.s.jdbc.datasource.DataSourceUtils      : Fetching JDBC Connection from DataSource
2022-12-02 00:48:48.510  INFO 14576 --- [nio-8004-exec-1] com.zaxxer.hikari.HikariDataSource       : HikariPool-2 - Starting...
2022-12-02 00:48:56.342  INFO 14576 --- [nio-8004-exec-1] com.zaxxer.hikari.pool.PoolBase          : HikariPool-2 - Driver does not support get/set network timeout for connections. (com.mysql.jdbc.JDBC4Connection.getNetworkTimeout()I)
2022-12-02 00:48:56.343  INFO 14576 --- [nio-8004-exec-1] com.zaxxer.hikari.HikariDataSource       : HikariPool-2 - Start completed.
2022-12-02 00:48:56.344 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Bound value [org.springframework.jdbc.datasource.ConnectionHolder@3ab3225e] for key [HikariDataSource (HikariPool-2)] to thread [http-nio-8004-exec-1]
2022-12-02 00:48:56.344 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.springframework.jdbc.datasource.ConnectionHolder@3ab3225e] for key [HikariDataSource (HikariPool-2)] bound to thread [http-nio-8004-exec-1]
JDBC Connection [HikariProxyConnection@1380915368 wrapping com.mysql.jdbc.JDBC4Connection@244f159e] will be managed by Spring
2022-12-02 00:48:56.345 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.springframework.jdbc.datasource.ConnectionHolder@3ab3225e] for key [HikariDataSource (HikariPool-2)] bound to thread [http-nio-8004-exec-1]
2022-12-02 00:48:56.345 DEBUG 14576 --- [nio-8004-exec-1] c.l.c.m.d.DsTwoChainTxInfoMapper.insert  : ==>  Preparing: INSERT INTO chain_tx_info ( name, age, create_date ) VALUES ( ?, ?, ? )
2022-12-02 00:48:56.345 DEBUG 14576 --- [nio-8004-exec-1] c.l.c.m.d.DsTwoChainTxInfoMapper.insert  : ==> Parameters: 11 error_dsTwo(String), 11(Integer), 2022-02-02 00:00:00.0(Timestamp)
2022-12-02 00:48:56.350 DEBUG 14576 --- [nio-8004-exec-1] c.l.c.m.d.DsTwoChainTxInfoMapper.insert  : <==    Updates: 1
2022-12-02 00:48:56.351 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.mybatis.spring.SqlSessionHolder@3b389b6e] for key [org.apache.ibatis.session.defaults.DefaultSqlSessionFactory@7adb9f37] bound to thread [http-nio-8004-exec-1]
2022-12-02 00:48:56.351 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.mybatis.spring.SqlSessionHolder@3b389b6e] for key [org.apache.ibatis.session.defaults.DefaultSqlSessionFactory@7adb9f37] bound to thread [http-nio-8004-exec-1]
Releasing transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@6ca1deee]
throw exception ======================================================================================
2022-12-02 00:48:56.351 TRACE 14576 --- [nio-8004-exec-1] o.s.t.i.TransactionInterceptor           : Completing transaction for [com.lwl.chaintx.service.ChainTxInfoServiceImpl.insertDbTwoError] after exception: java.lang.RuntimeException
2022-12-02 00:48:56.351 TRACE 14576 --- [nio-8004-exec-1] o.s.t.i.RuleBasedTransactionAttribute    : Applying rules to determine whether transaction should rollback on java.lang.RuntimeException
2022-12-02 00:48:56.351 TRACE 14576 --- [nio-8004-exec-1] o.s.t.i.RuleBasedTransactionAttribute    : Winning rollback rule is: null
2022-12-02 00:48:56.351 TRACE 14576 --- [nio-8004-exec-1] o.s.t.i.RuleBasedTransactionAttribute    : No relevant rollback rule found: applying default rules
2022-12-02 00:48:56.351 TRACE 14576 --- [nio-8004-exec-1] o.s.j.d.DataSourceTransactionManager     : Triggering beforeCompletion synchronization
Transaction synchronization deregistering SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@36a176e3]
2022-12-02 00:48:56.351 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Removed value [org.mybatis.spring.SqlSessionHolder@764b39a8] for key [org.apache.ibatis.session.defaults.DefaultSqlSessionFactory@a66ebbc] from thread [http-nio-8004-exec-1]
Transaction synchronization closing SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@36a176e3]
2022-12-02 00:48:56.352 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.springframework.jdbc.datasource.ConnectionHolder@4c3162d8] for key [HikariDataSource (HikariPool-1)] bound to thread [http-nio-8004-exec-1]
Transaction synchronization deregistering SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@6ca1deee]
2022-12-02 00:48:56.352 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Removed value [org.mybatis.spring.SqlSessionHolder@3b389b6e] for key [org.apache.ibatis.session.defaults.DefaultSqlSessionFactory@7adb9f37] from thread [http-nio-8004-exec-1]
Transaction synchronization closing SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@6ca1deee]
2022-12-02 00:48:56.352 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.springframework.jdbc.datasource.ConnectionHolder@3ab3225e] for key [HikariDataSource (HikariPool-2)] bound to thread [http-nio-8004-exec-1]
2022-12-02 00:48:56.352 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Removed value [org.springframework.jdbc.datasource.ConnectionHolder@3ab3225e] for key [HikariDataSource (HikariPool-2)] from thread [http-nio-8004-exec-1]
2022-12-02 00:48:56.353 DEBUG 14576 --- [nio-8004-exec-1] o.s.j.d.DataSourceTransactionManager     : Initiating transaction rollback
2022-12-02 00:48:56.353 DEBUG 14576 --- [nio-8004-exec-1] o.s.j.d.DataSourceTransactionManager     : Rolling back JDBC transaction on Connection [HikariProxyConnection@1155242370 wrapping com.mysql.jdbc.JDBC4Connection@544dfcd3]
2022-12-02 00:48:56.357 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Clearing transaction synchronization
2022-12-02 00:48:56.357 TRACE 14576 --- [nio-8004-exec-1] o.s.j.d.DataSourceTransactionManager     : Triggering afterCompletion synchronization
2022-12-02 00:48:56.357 TRACE 14576 --- [nio-8004-exec-1] .s.t.s.TransactionSynchronizationManager : Removed value [org.springframework.jdbc.datasource.ConnectionHolder@4c3162d8] for key [HikariDataSource (HikariPool-1)] from thread [http-nio-8004-exec-1]
2022-12-02 00:48:56.358 DEBUG 14576 --- [nio-8004-exec-1] o.s.j.d.DataSourceTransactionManager     : Releasing JDBC Connection [HikariProxyConnection@1155242370 wrapping com.mysql.jdbc.JDBC4Connection@544dfcd3] after transaction
2022-12-02 00:48:56.358 ERROR 14576 --- [nio-8004-exec-1] c.l.chaintx.controller.ChainController   : insertDbTwoError executor error: null
```

