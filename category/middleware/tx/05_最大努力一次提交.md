
**最大努力一次提交(Best Efforts 1PC) Best Efforts 1PC 模式相当通用，但在开发人员必须注意的某些情况下可能会失败。这是一种非XA模式**，涉及大量资源的同步单阶段提交。因为不使用2PC，所以它永远不会像 XA 交易那样安全，但如果参与者意识到妥协，它通常就足够了。许多大容量、高吞吐量的事务处理系统都是以这种方式设置的，以提高性能。
基本思想是在事务中尽可能晚地延迟所有资源的提交，以便唯一可能出错的是基础设施故障（而不是业务处理错误）。依赖 Best Efforts 1PC 的系统认为基础架构故障很少见，因此它们可以承担风险以换取更高的吞吐量。如果业务处理服务也被设计成幂等的，那么在实践中几乎不会出错。

## 1PC db和mq

**消息事务在数据库事务之前启动，并且它们以相反的顺序结束（提交或回滚）**

### 发送消息
- 开始消息事务
- 发送消息
- 启动数据库事务
- 更新数据库
- 提交数据库事务
- 提交消息事务

### 接收消息
成功的情况下的顺序可能和本文开头的顺序是一样的：
- 开始消息事务
- 接收消息
- 启动数据库事务
- 更新数据库
- 提交数据库事务
- 提交消息事务

关键在于最后两个步骤很重要：它们必须按此顺序放在最后。排序很重要的原因是技术上的，但顺序本身是由业务需求决定的。该订单告诉您，在这种情况下，其中一个交易资源是特殊的；它包含有关如何在另一方上开展工作的说明。这是一个业务排序：系统无法自动判断它是哪条路（尽管如果消息和数据库是两种资源，那么它通常是按这个顺序）。排序很重要的原因与失败案例有关。最常见的失败案例（到目前为止）是业务处理失败（错误数据、编程错误等）。在这种情况下，两个事务都可以很容易地被操纵以响应异常和回滚。

触发回滚的精确机制并不重要；有几个可用。重要的一点是提交或回滚以与资源中的业务顺序相反的顺序发生。在示例应用程序中，消息传递事务必须最后提交，因为业务流程的指令包含在该资源中。这很重要，因为（罕见的）失败案例是第一次提交成功而第二次提交失败。因为按照设计，此时所有业务处理都已经完成，所以这种部分失败的唯一原因是消息传递中间件的基础结构问题。

请注意，如果数据库资源的提交失败，那么最终效果仍然是回滚。因此，**唯一的非原子故障模式是第一个事务提交，第二个事务回滚。更一般地，如果n事务中有资源，则有n-1这种故障模式使一些资源在回滚后处于不一致（已提交）状态。在消息数据库用例中，这种故障模式的结果是消息被回滚并在另一个事务中返回，即使它已经被成功处理。因此，您可以安全地假设可能发生的最糟糕的事情是可以传递重复的消息**。在更一般的情况下，由于事务中较早的资源被认为可能携带有关如何对较晚的资源进行处理的信息，因此故障模式的最终结果通常可以称为重复消息。

有些人冒着重复消息很少发生的风险，以至于他们不会费心去预测它们。但是，为了对业务数据的正确性和一致性更有信心，您需要在业务逻辑中了解它们。如果业务处理意识到重复的消息可能到达，它所要做的（通常需要一些额外的成本，但不像2PC那样多）是检查它之前是否处理过该数据，如果已经处理过则什么也不做。这种专门化有时称为幂等业务服务模式。

[](https://www.javaworld.com/article/2077963/open-source-tools/distributed-transactions-in-spring--with-and-without-xa.html)

## 基于TransactionAwareConnectionFactoryProxy 实现active mq
``` java
public class ActivateMqConfig {
    @Bean
    public ConnectionFactoryconnectionFactory() {
        ConnectionFactory cf = new ActiveMQConnectionFactory("tcp://127.0.0.1:");
        // jms包下的，不是jca包下的
        TransactionAwareConnectionFactoryProxy proxy = new TransactionAwareConnectionFactoryProxy();
        proxy.setTargetConnectionFactory(cf);
        proxy.setSynchedLocalTransactionAllowed(true);
        return proxy;
    }

    @Bean
    public ImsTemplate jmsTemplate(ConnectionFactory connectionFactory) {
        JmsTemplate imsTemplate = new JmsTemplate(connectionFactory);
        jmsTemplate.setSessionTransacted():
    }
}
```

## 基于ChainedTransactionManager 实现rabbitmq
> 由于rabbitmq实现的AMQP协议，不是实现的jms协议，因此无法使用 TransactionAwareConnectionFactoryProxy 来实现1pc，只能通过 ChainedTransactionManager 来实现1pc

``` java
@Configuration
public class RabbitMQConfig {
    // 配置rabbit admin
    @Bean
    public RabbitAdmin rabbitAdmin(ConnectionFactory connectionFactory) {
        RabbitAdmin rabbitAdmin = new RabbitAdmin(connectionFactory);
        rabbitAdmin.setAutoStartup(true);
        return rabbitAdmin;
    }
}

```
``` java
@Configuration
public class ChainTxConfig {
    // db事务，并且优先使用db事务
    @Primary
    @Bean("dbTransactionManager")
    public DataSourceTransactionManager dataSourceTransactionManager(DataSource dataSource) {
        return new DataSourceTransactionManager(dataSource);
    }

    // 开启rabbit mq事务提交
    @Bean("rabbitTransactionManager")
    public RabbitTransactionManager rabbitTransactionManager(ConnectionFactory connectionFactory) {
        return new RabbitTransactionManager(connectionFactory);
    }

    // rabbitmq 和 db 的链式事务
    @Bean("rabbitAndDbTransactionManager")
    public PlatformTransactionManager chainedTransactionManager(
            ConnectionFactory connectionFactory,
            DataSourceTransactionManager dataSourceTransactionManager) {
        return new ChainedTransactionManager(rabbitTransactionManager(connectionFactory), dataSourceTransactionManager);
    }
}

```

``` log
2022-12-05 23:01:18.021 TRACE 5044 --- [nio-8005-exec-7] .s.t.s.TransactionSynchronizationManager : Initializing transaction synchronization
2022-12-05 23:01:18.021 TRACE 5044 --- [nio-8005-exec-7] .s.t.s.TransactionSynchronizationManager : Clearing transaction synchronization
// 开启rabbitmq的事务
2022-12-05 23:01:18.021 DEBUG 5044 --- [nio-8005-exec-7] o.s.a.r.t.RabbitTransactionManager       : Creating new transaction with name [com.lwl.mqdb.service.MqDbServiceImpl.sendMessageAndInsertDb]: PROPAGATION_REQUIRED,ISOLATION_DEFAULT; 'rabbitAndDbTransactionManager'
2022-12-05 23:01:18.021 DEBUG 5044 --- [nio-8005-exec-7] o.s.a.r.t.RabbitTransactionManager       : Created AMQP transaction on channel [Cached Rabbit Channel: AMQChannel(amqp://admin@192.168.111.15:5672/,1), conn: Proxy@4e8575a6 Shared Rabbit Connection: SimpleConnection@389734ec [delegate=amqp://admin@192.168.111.15:5672/, localPort= 51690]]
2022-12-05 23:01:18.021 TRACE 5044 --- [nio-8005-exec-7] .s.t.s.TransactionSynchronizationManager : Bound value [org.springframework.amqp.rabbit.connection.RabbitResourceHolder@17a24a2f] for key [CachingConnectionFactory [channelCacheSize=25, host=DESKTOP-N94QDPP, port=5672, active=true connectionFactory]] to thread [http-nio-8005-exec-7]
2022-12-05 23:01:18.021 TRACE 5044 --- [nio-8005-exec-7] .s.t.s.TransactionSynchronizationManager : Initializing transaction synchronization
2022-12-05 23:01:18.021 TRACE 5044 --- [nio-8005-exec-7] .s.t.s.TransactionSynchronizationManager : Clearing transaction synchronization
// 开启数据库事务
2022-12-05 23:01:18.021 DEBUG 5044 --- [nio-8005-exec-7] o.s.j.d.DataSourceTransactionManager     : Creating new transaction with name [com.lwl.mqdb.service.MqDbServiceImpl.sendMessageAndInsertDb]: PROPAGATION_REQUIRED,ISOLATION_DEFAULT; 'rabbitAndDbTransactionManager'
2022-12-05 23:01:18.022 DEBUG 5044 --- [nio-8005-exec-7] o.s.j.d.DataSourceTransactionManager     : Acquired Connection [HikariProxyConnection@426092203 wrapping com.mysql.jdbc.JDBC4Connection@533189f4] for JDBC transaction
2022-12-05 23:01:18.022 DEBUG 5044 --- [nio-8005-exec-7] o.s.j.d.DataSourceTransactionManager     : Switching JDBC Connection [HikariProxyConnection@426092203 wrapping com.mysql.jdbc.JDBC4Connection@533189f4] to manual commit
2022-12-05 23:01:18.023 TRACE 5044 --- [nio-8005-exec-7] .s.t.s.TransactionSynchronizationManager : Bound value [org.springframework.jdbc.datasource.ConnectionHolder@1d5a215f] for key [HikariDataSource (HikariPool-1)] to thread [http-nio-8005-exec-7]
2022-12-05 23:01:18.023 TRACE 5044 --- [nio-8005-exec-7] .s.t.s.TransactionSynchronizationManager : Initializing transaction synchronization
2022-12-05 23:01:18.023 TRACE 5044 --- [nio-8005-exec-7] o.s.t.i.TransactionInterceptor           : Getting transaction for [com.lwl.mqdb.service.MqDbServiceImpl.sendMessageAndInsertDb]
Creating a new SqlSession
Registering transaction synchronization for SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@5858ac90]
2022-12-05 23:01:18.023 TRACE 5044 --- [nio-8005-exec-7] .s.t.s.TransactionSynchronizationManager : Bound value [org.mybatis.spring.SqlSessionHolder@5d2e6686] for key [org.apache.ibatis.session.defaults.DefaultSqlSessionFactory@640de630] to thread [http-nio-8005-exec-7]
2022-12-05 23:01:18.024 TRACE 5044 --- [nio-8005-exec-7] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.springframework.jdbc.datasource.ConnectionHolder@1d5a215f] for key [HikariDataSource (HikariPool-1)] bound to thread [http-nio-8005-exec-7]
2022-12-05 23:01:18.024 TRACE 5044 --- [nio-8005-exec-7] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.springframework.jdbc.datasource.ConnectionHolder@1d5a215f] for key [HikariDataSource (HikariPool-1)] bound to thread [http-nio-8005-exec-7]
JDBC Connection [HikariProxyConnection@426092203 wrapping com.mysql.jdbc.JDBC4Connection@533189f4] will be managed by Spring
2022-12-05 23:01:18.024 TRACE 5044 --- [nio-8005-exec-7] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.springframework.jdbc.datasource.ConnectionHolder@1d5a215f] for key [HikariDataSource (HikariPool-1)] bound to thread [http-nio-8005-exec-7]
==>  Preparing: INSERT INTO mq_db_info ( name, age, create_date ) VALUES ( ?, ?, ? )
==> Parameters: all(String), 111(Integer), 2022-10-11 00:00:00.0(Timestamp)
<==    Updates: 1
2022-12-05 23:01:18.025 TRACE 5044 --- [nio-8005-exec-7] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.mybatis.spring.SqlSessionHolder@5d2e6686] for key [org.apache.ibatis.session.defaults.DefaultSqlSessionFactory@640de630] bound to thread [http-nio-8005-exec-7]
2022-12-05 23:01:18.025 TRACE 5044 --- [nio-8005-exec-7] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.mybatis.spring.SqlSessionHolder@5d2e6686] for key [org.apache.ibatis.session.defaults.DefaultSqlSessionFactory@640de630] bound to thread [http-nio-8005-exec-7]
Releasing transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@5858ac90]
2022-12-05 23:01:18.025 DEBUG 5044 --- [nio-8005-exec-7] o.s.amqp.rabbit.core.RabbitTemplate      : Executing callback RabbitTemplate$$Lambda$695/2013674971 on RabbitMQ Channel: Cached Rabbit Channel: AMQChannel(amqp://admin@192.168.111.15:5672/,2), conn: Proxy@4e8575a6 Shared Rabbit Connection: SimpleConnection@389734ec [delegate=amqp://admin@192.168.111.15:5672/, localPort= 51690]
2022-12-05 23:01:18.025 DEBUG 5044 --- [nio-8005-exec-7] o.s.amqp.rabbit.core.RabbitTemplate      : Publishing message [(Body:'[B@387753df(byte[6])' MessageProperties [headers={}, contentType=application/octet-stream, contentLength=0, deliveryMode=PERSISTENT, priority=0, deliveryTag=0])] on exchange [mq_db_exchange], routingKey = [mq_db]
2022-12-05 23:01:18.025 TRACE 5044 --- [nio-8005-exec-7] o.s.t.i.TransactionInterceptor           : Completing transaction for [com.lwl.mqdb.service.MqDbServiceImpl.sendMessageAndInsertDb]
2022-12-05 23:01:18.025 TRACE 5044 --- [nio-8005-exec-7] o.s.j.d.DataSourceTransactionManager     : Triggering beforeCommit synchronization
Transaction synchronization committing SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@5858ac90]
2022-12-05 23:01:18.025 TRACE 5044 --- [nio-8005-exec-7] o.s.j.d.DataSourceTransactionManager     : Triggering beforeCompletion synchronization
Transaction synchronization deregistering SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@5858ac90]
2022-12-05 23:01:18.025 TRACE 5044 --- [nio-8005-exec-7] .s.t.s.TransactionSynchronizationManager : Removed value [org.mybatis.spring.SqlSessionHolder@5d2e6686] for key [org.apache.ibatis.session.defaults.DefaultSqlSessionFactory@640de630] from thread [http-nio-8005-exec-7]
Transaction synchronization closing SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@5858ac90]
2022-12-05 23:01:18.025 TRACE 5044 --- [nio-8005-exec-7] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.springframework.jdbc.datasource.ConnectionHolder@1d5a215f] for key [HikariDataSource (HikariPool-1)] bound to thread [http-nio-8005-exec-7]
2022-12-05 23:01:18.026 DEBUG 5044 --- [nio-8005-exec-7] o.s.j.d.DataSourceTransactionManager     : Initiating transaction commit
// 提交 数据库的事务 
2022-12-05 23:01:18.026 DEBUG 5044 --- [nio-8005-exec-7] o.s.j.d.DataSourceTransactionManager     : Committing JDBC transaction on Connection [HikariProxyConnection@426092203 wrapping com.mysql.jdbc.JDBC4Connection@533189f4]
2022-12-05 23:01:18.031 TRACE 5044 --- [nio-8005-exec-7] o.s.j.d.DataSourceTransactionManager     : Triggering afterCommit synchronization
2022-12-05 23:01:18.032 TRACE 5044 --- [nio-8005-exec-7] .s.t.s.TransactionSynchronizationManager : Clearing transaction synchronization
2022-12-05 23:01:18.032 TRACE 5044 --- [nio-8005-exec-7] o.s.j.d.DataSourceTransactionManager     : Triggering afterCompletion synchronization
2022-12-05 23:01:18.032 TRACE 5044 --- [nio-8005-exec-7] .s.t.s.TransactionSynchronizationManager : Removed value [org.springframework.jdbc.datasource.ConnectionHolder@1d5a215f] for key [HikariDataSource (HikariPool-1)] from thread [http-nio-8005-exec-7]
2022-12-05 23:01:18.032 DEBUG 5044 --- [nio-8005-exec-7] o.s.j.d.DataSourceTransactionManager     : Releasing JDBC Connection [HikariProxyConnection@426092203 wrapping com.mysql.jdbc.JDBC4Connection@533189f4] after transaction
2022-12-05 23:01:18.032 DEBUG 5044 --- [nio-8005-exec-7] o.s.j.d.DataSourceTransactionManager     : Resuming suspended transaction after completion of inner transaction
2022-12-05 23:01:18.032 TRACE 5044 --- [nio-8005-exec-7] .s.t.s.TransactionSynchronizationManager : Initializing transaction synchronization
// 提交 rabbitmq的事务
2022-12-05 23:01:18.033 DEBUG 5044 --- [nio-8005-exec-7] o.s.a.r.t.RabbitTransactionManager       : Initiating transaction commit
2022-12-05 23:01:18.034 TRACE 5044 --- [nio-8005-exec-7] .s.t.s.TransactionSynchronizationManager : Clearing transaction synchronization
2022-12-05 23:01:18.034 TRACE 5044 --- [nio-8005-exec-7] .s.t.s.TransactionSynchronizationManager : Removed value [org.springframework.amqp.rabbit.connection.RabbitResourceHolder@17a24a2f] for key [CachingConnectionFactory [channelCacheSize=25, host=DESKTOP-N94QDPP, port=5672, active=true connectionFactory]] from thread [http-nio-8005-exec-7]
2022-12-05 23:01:18.034 DEBUG 5044 --- [nio-8005-exec-7] o.s.a.r.t.RabbitTransactionManager       : Resuming suspended transaction after completion of inner transaction
2022-12-05 23:01:18.034 TRACE 5044 --- [nio-8005-exec-7] .s.t.s.TransactionSynchronizationManager : Initializing transaction synchronization
```


